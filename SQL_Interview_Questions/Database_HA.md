# Assuming there is table with 100 million rows, how to duplicate this table without interrupting access?

针对 **MS SQL Server**，在不中断访问的情况下完成大表复制可以采取以下几种优化策略，这些方法可以保证数据的一致性和系统的高可用性，同时尽量减少对数据库性能的影响。

### 1. **基于批次的复制（Batch Processing）**
   - **分批复制数据**：可以通过限制批次大小的方式复制表中的数据，避免一次性复制大量数据导致性能瓶颈。使用 `ROW_NUMBER()` 或其他方法限制每次复制的行数。
   - **示例**：
     ```sql
     WHILE (SELECT COUNT(*) FROM SourceTable) > 0
     BEGIN
         INSERT INTO TargetTable (Col1, Col2)
         SELECT TOP (10000) Col1, Col2
         FROM SourceTable
         WHERE <条件>
         ORDER BY Col1;

         -- 删除已经复制的数据（根据业务需求调整）
         DELETE TOP (10000) FROM SourceTable WHERE <条件>;
     END
     ```
   - **优势**：分批复制大表数据不会锁定整张表，可以减少对用户访问的影响。

### 2. **使用事务日志复制（Log Shipping）**
   - **事务日志复制**是 SQL Server 中常用的高可用性和数据复制技术之一。它通过备份主数据库的事务日志，并将其传送到辅助数据库进行还原。
   - **步骤**：
     1. 创建主数据库的完整备份。
     2. 定期备份事务日志，并将其应用到辅助数据库。
     3. 在不影响主数据库访问的情况下，持续同步数据变更。
   - **优势**：这是一个成熟且可靠的解决方案，适合用于大表数据复制和灾难恢复。

### 3. **SQL Server 分区表**
   - **分区表**允许将大表按照逻辑范围分为多个分区（例如按日期、ID范围等），并且每个分区可以单独管理。
   - **过程**：
     1. 将大表转换为分区表。
     2. 按分区逐个进行数据的复制和切换。
     3. 这样可以有效减少大表全表扫描的负担，并在复制时只锁定一个分区，从而保持表的大部分可用性。
   - **优势**：通过分区减少复制对系统性能的影响，适合大表数据量特别大且数据可以按时间段分割的场景。

### 4. **使用 `BCP` 工具进行数据导出与导入**
   - **`BCP (Bulk Copy Program)`** 是 SQL Server 提供的高效批量数据导入导出的工具。
   - **过程**：
     1. 使用 `BCP OUT` 命令从源表导出数据到文件。
     2. 使用 `BCP IN` 命令将文件中的数据导入到目标表。
     3. 此过程可以分批进行，且不影响表的读取操作。
   - **示例**：
     ```bash
     bcp SourceDatabase.dbo.SourceTable out datafile.txt -S ServerName -T -c
     bcp TargetDatabase.dbo.TargetTable in datafile.txt -S ServerName -T -c
     ```
   - **优势**：`BCP` 工具高效且适合大批量数据的迁移和复制。

### 5. **使用 `Transactional Replication`（事务复制）**
   - **事务复制**是 SQL Server 中专门为保持数据一致性而设计的复制技术，尤其适合需要实时复制的场景。事务复制可以将大表的初始数据复制到副本表，并将增量变更实时同步。
   - **过程**：
     1. 设置发布者和订阅者（Publisher 和 Subscriber）。
     2. 通过事务日志将原表的增量数据变更实时复制到目标表。
   - **优势**：事务复制可以在不中断表访问的情况下保持数据的实时同步，适合频繁更新的大表。

### 6. **Always On 可用性组**
   - **SQL Server Always On 可用性组** 是一种企业级高可用性和灾难恢复解决方案，它允许将主数据库的副本自动同步到一个或多个辅助副本。
   - **步骤**：
     1. 设置主数据库和辅助副本。
     2. 在主数据库上进行所有写操作，同时同步更新到辅助副本。
     3. 如果需要复制大表，可以在辅助副本上进行表复制，而不会影响主数据库的可用性。
   - **优势**：高可用性组允许在不影响用户访问的情况下进行大规模的数据复制操作。

### 7. **临时快照（Database Snapshot）+ 数据同步**
   - **数据库快照**可以为一个表或数据库创建静态视图，然后对快照进行操作，不影响主表的更新。
   - **过程**：
     1. 生成源表的快照。
     2. 基于快照进行表复制。
     3. 复制完成后，将快照和主表的增量数据进行合并。
   - **优势**：通过快照可以避免对原始表进行直接操作，从而避免影响正在进行的读写操作。

---

### 总结：
在 MS SQL Server 中，不停止访问的前提下完成大表复制的关键是**减少锁定时间**和**减少对系统性能的影响**。通过使用批次复制、事务日志复制、分区表、`BCP` 工具或 **Always On 可用性组**，可以确保数据复制的稳定性与可用性。在实施过程中，应根据实际的业务场景选择合适的解决方案。